<!DOCTYPE html><!--[if lte IE 8]>
<html lang="en" class="lte-ie8">
<![endif]-->
<!--[if gt IE 8]><!-->
<html lang="en">
<!--<![endif]--><head><meta charset="utf-8"><title>October 3, 2015</title><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/diary/styles/global.css"><link rel="stylesheet" href="/diary/styles/tomorrow.css"><link rel="stylesheet" href="/diary/styles/diary.css"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-63818301-1', 'auto');
ga('send', 'pageview');</script></head><body><header class="header"><div class="index"><a href="/diary/">Index</a></div><h1>October 3, 2015</h1></header><div class="content"><div class="diary"><h2 id="c">C</h2>
<h3 id="-can-you-write-object-oriented-code-in-c-http-stackoverflow-com-questions-351733-can-you-write-object-oriented-code-in-c-"><a href="http://stackoverflow.com/questions/351733/can-you-write-object-oriented-code-in-c">Can you write object oriented code in C?</a></h3>
<ul>
<li>You need to implement something like a vtable(with function pointer table) and a this pointer</li>
<li>ffmpeg makes heavy use of structs and function pointers to do OOP in C</li>
<li>GNOME implemented <a href="https://developer.gnome.org/gobject/unstable/">GObject</a> for OOP in C</li>
</ul>
<h4 id="inheritance">Inheritance</h4>
<pre><code class="lang-c"><span class="hljs-keyword">struct</span> base
{
    <span class="hljs-comment">/* base class members */</span>
};

<span class="hljs-keyword">struct</span> derived
{
    <span class="hljs-keyword">struct</span> base super;
    <span class="hljs-comment">/* derived class members */</span>
};

<span class="hljs-keyword">struct</span> derived d;
<span class="hljs-keyword">struct</span> base *base_ptr = (<span class="hljs-keyword">struct</span> base *)&amp;d;  <span class="hljs-comment">// upcast</span>
<span class="hljs-keyword">struct</span> derived *derived_ptr = (<span class="hljs-keyword">struct</span> derived *)base_ptr;  <span class="hljs-comment">// downcast</span>
</code></pre>
<h4 id="another-vtable-like-implementation">Another vtable-like implementation</h4>
<pre><code class="lang-c"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {
    <span class="hljs-keyword">int</span> (*open)(<span class="hljs-keyword">void</span> *self, <span class="hljs-keyword">char</span> *fspec);
    <span class="hljs-keyword">int</span> (*close)(<span class="hljs-keyword">void</span> *self);
    <span class="hljs-keyword">int</span> (*read)(<span class="hljs-keyword">void</span> *self, <span class="hljs-keyword">void</span> *buff, <span class="hljs-keyword">size_t</span> max_sz, <span class="hljs-keyword">size_t</span> *p_act_sz);
    <span class="hljs-keyword">int</span> (*write)(<span class="hljs-keyword">void</span> *self, <span class="hljs-keyword">void</span> *buff, <span class="hljs-keyword">size_t</span> max_sz, <span class="hljs-keyword">size_t</span> *p_act_sz);
    <span class="hljs-comment">// And data goes here.</span>
} Communication;

<span class="hljs-comment">// Implement your functions...</span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">tcpOpen</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *self, <span class="hljs-keyword">char</span> *fspec)</span> </span>{
  <span class="hljs-comment">// ....</span>
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">httpOpen</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *self, <span class="hljs-keyword">char</span> *fspec)</span> </span>{
  <span class="hljs-comment">// ....</span>
}

<span class="hljs-comment">//.....</span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">tcpWrite</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *self, <span class="hljs-keyword">void</span> *buff, size_t max_sz, size_t *p_act_sz)</span> </span>{
  <span class="hljs-comment">// ....</span>
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">httpWrite</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *self, <span class="hljs-keyword">void</span> *buff, size_t max_sz, size_t *p_act_sz)</span> </span>{
  <span class="hljs-comment">// ....</span>
}

<span class="hljs-comment">// Constructor</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">tcpInit</span><span class="hljs-params">(Communication *self)</span> </span>{
  self.open = &amp;tcpOpen;
  <span class="hljs-comment">// ...</span>
  self.write = &amp;tcpWrite;
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">httpInit</span><span class="hljs-params">(Communication *self)</span> </span>{
  self.open = &amp;httpOpen;
  <span class="hljs-comment">// ...</span>
  self.write = &amp;httpWrite;
}

<span class="hljs-comment">// Then you can do</span>

<span class="hljs-keyword">int</span> status;
Communication commTcp, commHttp;
tcpInit(&amp;commTcp);
httpInit(&amp;commHttp);
status = (commTcp.open)(&amp;commTcp, <span class="hljs-string">"example.com:5000"</span>);
status = (commHttp.open)(&amp;commHttp, <span class="hljs-string">"example.com:5000"</span>);
<span class="hljs-comment">// ...</span>
</code></pre>
<h4 id="polymorphism">Polymorphism</h4>
<pre><code class="lang-c"><span class="hljs-keyword">struct</span> base;
<span class="hljs-keyword">struct</span> base_vtable
{
    <span class="hljs-keyword">void</span> (*dance)(<span class="hljs-keyword">struct</span> base *);
    <span class="hljs-keyword">void</span> (*jump)(<span class="hljs-keyword">struct</span> base *, <span class="hljs-keyword">int</span> how_high);
};

<span class="hljs-keyword">struct</span> base
{
    <span class="hljs-keyword">struct</span> base_vtable *vtable;
    <span class="hljs-comment">/* base members */</span>
};

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">base_dance</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> base *b)</span>
</span>{
    b-&gt;vtable-&gt;dance(b);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">base_jump</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> base *b, <span class="hljs-keyword">int</span> how_high)</span>
</span>{
    b-&gt;vtable-&gt;jump(b, how_high);
}

<span class="hljs-keyword">struct</span> derived1
{
    <span class="hljs-keyword">struct</span> base super;
    <span class="hljs-comment">/* derived1 members */</span>
};

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">derived1_dance</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> derived1 *d)</span>
</span>{
    <span class="hljs-comment">/* implementation of derived1's dance function */</span>
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">derived1_jump</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> derived1 *d, <span class="hljs-keyword">int</span> how_high)</span>
</span>{
    <span class="hljs-comment">/* implementation of derived 1's jump function */</span>
}

<span class="hljs-comment">/* global vtable for derived1 */</span>
<span class="hljs-keyword">struct</span> base_vtable derived1_vtable =
{
    &amp;derived1_dance, <span class="hljs-comment">/* you might get a warning here about incompatible pointer types */</span>
    &amp;derived1_jump   <span class="hljs-comment">/* you can ignore it, or perform a cast to get rid of it */</span>
};

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">derived1_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> derived1 *d)</span>
</span>{
    d-&gt;super.vtable = &amp;derived1_vtable;
    <span class="hljs-comment">/* init base members d-&gt;super.foo */</span>
    <span class="hljs-comment">/* init derived1 members d-&gt;foo */</span>
}

<span class="hljs-keyword">struct</span> derived2
{
    <span class="hljs-keyword">struct</span> base super;
    <span class="hljs-comment">/* derived2 members */</span>
};

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">derived2_dance</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> derived2 *d)</span>
</span>{
    <span class="hljs-comment">/* implementation of derived2's dance function */</span>
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">derived2_jump</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> derived2 *d, <span class="hljs-keyword">int</span> how_high)</span>
</span>{
    <span class="hljs-comment">/* implementation of derived2's jump function */</span>
}

<span class="hljs-keyword">struct</span> base_vtable derived2_vtable =
{
   &amp;derived2_dance,
   &amp;derived2_jump
};

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">derived2_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> derived2 *d)</span>
</span>{
    d-&gt;super.vtable = &amp;derived2_vtable;
    <span class="hljs-comment">/* init base members d-&gt;super.foo */</span>
    <span class="hljs-comment">/* init derived1 members d-&gt;foo */</span>
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-comment">/* OK!  We're done with our declarations, now we can finally do some
       polymorphism in C */</span>
    <span class="hljs-keyword">struct</span> derived1 d1;
    derived1_init(&amp;d1);

    <span class="hljs-keyword">struct</span> derived2 d2;
    derived2_init(&amp;d2);

    <span class="hljs-keyword">struct</span> base *b1_ptr = (<span class="hljs-keyword">struct</span> base *)&amp;d1;
    <span class="hljs-keyword">struct</span> base *b2_ptr = (<span class="hljs-keyword">struct</span> base *)&amp;d2;

    base_dance(b1_ptr);  <span class="hljs-comment">/* calls derived1_dance */</span>
    base_dance(b2_ptr);  <span class="hljs-comment">/* calls derived2_dance */</span>

    base_jump(b1_ptr, <span class="hljs-number">42</span>);  <span class="hljs-comment">/* calls derived1_jump */</span>
    base_jump(b2_ptr, <span class="hljs-number">42</span>);  <span class="hljs-comment">/* calls derived2_jump */</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 id="resources">Resources</h4>
<ul>
<li><a href="http://stackoverflow.com/questions/415452/object-orientation-in-c">Object-Orientation in C</a></li>
<li><a href="http://www.cs.rit.edu/~ats/books/ooc.pdf">Object-Oriented Programming With ANSI-C</a></li>
<li><a href="http://dmitryfrank.com/articles/oop_in_c">Object-oriented techniques in C</a></li>
<li><a href="http://ldeniau.web.cern.ch/ldeniau/html/oopc.html">Object Oriented Programming in C</a></li>
</ul>
</div></div><footer class="footer"><address class="author">Copyright &copy;<a rel="author" href="https://github.com/joyeecheung" class="author-name">Joyee Cheung</a>-<a href="https://github.com/joyeecheung/my-tech-diary" class="source-repo">Source</a></address><p>Generated by<a href="https://github.com/joyeecheung/diary" class="site-repo">Joyee Cheung&#39;s diary generator</a></p></footer></body></html>